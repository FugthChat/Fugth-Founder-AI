<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>FugthAI - Conversational AI Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root, html[data-theme="light"] {
            --bg-main: #f4f7f9; --bg-sidebar: #ffffff; --bg-input: #ffffff; --bg-menu: #ffffff;
            --bg-message-user: #eef2ff; --bg-message-bot: #ffffff; --text-primary: #111827;
            --text-secondary: #6b7280; --accent: #4f46e5; --danger: #ef4444;
            --border-color: #e5e7eb; --shadow-color: rgba(0, 0, 0, 0.05); --code-bg: #1f2937;
        }
        html[data-theme="dark"] {
            --bg-main: #111111; --bg-sidebar: #191919; --bg-input: #191919; --bg-menu: #242424;
            --bg-message-user: #2a2a2e; --bg-message-bot: #191919; --text-primary: #f9fafb;
            --text-secondary: #9ca3af; --accent: #818cf8; --danger: #f87171;
            --border-color: #374151; --shadow-color: rgba(255, 255, 255, 0.05); --code-bg: #1f2937;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); overflow: hidden; }
        .prose { color: var(--text-primary); }
        .prose code:not(pre *) { background-color: rgba(0,0,0,0.05); padding: 2px 5px; border-radius: 4px; font-family: 'Space Grotesk', monospace; font-size: 0.9em; }
        html[data-theme="dark"] .prose code:not(pre *) { background-color: rgba(255,255,255,0.1); }
        .prose pre { background-color: var(--code-bg); padding: 1.25rem 1rem; border-radius: 0.5rem; color: #d1d5db; position: relative; }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { color: var(--accent); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: #374151; color: #9ca3af; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em; opacity: 0; transition: opacity 0.2s; }
        .prose pre:hover .copy-btn { opacity: 1; }
        .sidebar { transition: width 0.3s ease, transform 0.3s ease; }
        .tab-btn.active { background-color: var(--accent); color: white; }
        .tab-btn { color: var(--text-secondary); }
    </style>
</head>
<body class="flex h-screen overflow-hidden antialiased">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 opacity-0 pointer-events-none transition-opacity md:hidden"></div>
    
    <aside id="left-sidebar" class="sidebar bg-[var(--bg-sidebar)] p-4 flex flex-col border-r border-[var(--border-color)] flex-shrink-0 md:w-20 md:hover:w-72">
        <div class="flex items-center mb-6 flex-shrink-0">
            <h1 class="text-xl font-bold font-['Space_Grotesk'] overflow-hidden">F<span class="sidebar-brand-text">ugth</span><span class="text-[var(--accent)] sidebar-brand-text">AI</span></h1>
            <button id="theme-btn" class="hover:bg-black/10 dark:hover:bg-white/10 p-2 rounded-full text-lg ml-auto"><i class="fa-solid fa-moon"></i></button>
        </div>

        <div class="flex border border-[var(--border-color)] rounded-lg p-1 mb-4">
            <button id="chatbot-tab-btn" class="tab-btn active w-full py-2 px-3 rounded-lg text-sm flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-comments"></i><span class="ml-2 sidebar-text font-semibold">Chatbot</span>
            </button>
            <button id="workspace-tab-btn" class="tab-btn w-full py-2 px-3 rounded-lg text-sm flex items-center justify-center">
                <i class="fa-solid fa-lightbulb"></i><span class="ml-2 sidebar-text font-semibold">Workspace</span>
            </button>
        </div>

        <div id="chatbot-sidebar-content" class="flex flex-col flex-1 overflow-y-auto -mr-4 pr-4">
            <button id="new-chat-btn" class="w-full py-2.5 px-3 rounded-lg bg-[var(--accent)] text-white hover:opacity-90 mb-4 transition-all text-sm flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-plus mr-2"></i><span class="sidebar-text font-semibold">New Chat</span>
            </button>
            <nav id="chat-list" class="flex-1 overflow-y-auto space-y-1"></nav>
        </div>
        
        <div id="workspace-sidebar-content" class="hidden flex-col flex-1 overflow-y-auto -mr-4 pr-4">
            <button id="new-project-btn" class="w-full py-2.5 px-3 rounded-lg bg-[var(--accent)] text-white hover:opacity-90 mb-4 transition-all text-sm flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-plus mr-2"></i><span class="sidebar-text font-semibold">New Project</span>
            </button>
            <nav id="project-list" class="flex-1 overflow-y-auto space-y-1"></nav>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 relative">
        <header class="p-3 flex justify-between items-center border-b border-[var(--border-color)] flex-shrink-0 bg-[var(--bg-main)]/80 backdrop-blur-sm">
            <div class="flex items-center">
                <button id="toggle-left-sidebar" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 mr-2 md:hidden"><i class="fa-solid fa-bars"></i></button>
                <h2 id="view-title" class="font-semibold truncate text-lg">New Chat</h2>
            </div>
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <select id="model-switcher" class="bg-[var(--bg-input)] border border-[var(--border-color)] rounded-md py-1.5 pl-3 pr-8 text-sm appearance-none focus:outline-none focus:ring-1 focus:ring-[var(--accent)]">
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-[var(--text-secondary)] pointer-events-none"></i>
                </div>
            </div>
        </header>

        <div id="chatbot-view" class="flex flex-col flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
             <div id="welcome-message" class="text-center pt-16">
                <div class="inline-block p-5 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 mb-6 shadow-lg"><i class="fa-solid fa-wand-magic-sparkles text-5xl text-white"></i></div>
                <h1 class="text-4xl font-bold font-['Space_Grotesk']">FugthAI</h1>
                <p class="text-[var(--text-secondary)] mt-2">How can I help you today?</p>
            </div>
            <div id="chat-history" class="space-y-6"></div>
        </div>

        <div id="workspace-view" class="hidden flex-col flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
            <div class="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)]">
                <h3 class="text-lg font-bold mb-2 font-['Space_Grotesk']">Project Outline</h3>
                <p class="text-sm text-[var(--text-secondary)] mb-4">Map out your project ideas, features, and notes here.</p>
                <textarea id="workspace-outline" class="w-full h-48 bg-[var(--bg-input)] border border-[var(--border-color)] rounded-md p-3 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--accent)] resize-y"></textarea>
            </div>
            <div class="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)]">
                <h3 class="text-lg font-bold font-['Space_Grotesk']">AI Generation Controls</h3>
                <div class="bg-black/5 dark:bg-white/5 p-3 rounded-md my-4 space-y-3">
                    <div>
                        <label for="line-count-slider" class="block text-sm font-medium text-[var(--text-secondary)]">
                            Desired Lines of Code: <span id="line-count-value" class="font-bold text-[var(--accent)]">100</span>
                        </label>
                        <input id="line-count-slider" type="range" min="0" max="3000" value="100" step="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    </div>
                    <button id="generate-script-btn" class="w-full py-2 px-4 rounded-lg bg-[var(--accent)] text-white hover:opacity-90 text-sm flex items-center justify-center shadow-sm disabled:opacity-50" disabled>
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate Script
                    </button>
                </div>
                 <h3 class="text-lg font-bold mb-2 font-['Space_Grotesk']">Generated Script</h3>
                <div id="workspace-script-container" class="prose max-w-none flex-1 bg-[var(--bg-input)] border border-[var(--border-color)] rounded-md text-sm min-h-[200px] overflow-auto">
                    <pre><code id="workspace-script" class="language-plaintext">No script generated yet.</code></pre>
                </div>
            </div>
        </div>
        
        <footer id="chatbot-footer" class="p-4 flex-shrink-0 bg-transparent">
            <div class="max-w-4xl mx-auto">
                <div id="status-bar" class="h-5 mb-2 flex items-center gap-2 text-xs text-[var(--text-secondary)]">
                    <div id="status-dot" class="w-2 h-2 rounded-full"></div><span id="status-text"></span>
                </div>
                <div class="relative flex items-center bg-[var(--bg-input)] rounded-2xl shadow-md border border-[var(--border-color)] focus-within:border-[var(--accent)]">
                    <textarea id="prompt-input" rows="1" class="w-full bg-transparent p-3 outline-none resize-none disabled:opacity-50" placeholder="Ask FugthAI anything…"></textarea>
                    <button id="send-btn" class="p-3 m-1 rounded-lg bg-[var(--accent)] text-white hover:opacity-90 disabled:opacity-50"><i class="fa-solid fa-arrow-up"></i></button>
                </div>
            </div>
        </footer>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = sel => document.querySelector(sel);

    const HUGGING_FACE_URL = "https://fugthchat-fugth-founder-ai.hf.space";
    
    const LOCAL_STORAGE_KEY = {
        CHATS: 'fugthai_chats_v22',
        THEME: 'fugthai_theme_v22',
        PROJECTS: 'fugthai_projects_v22'
    };
    
    let state = {
        chats: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY.CHATS) || '[]'),
        projects: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY.PROJECTS) || '[]'),
        availableModels: {},
        activeChatId: null,
        activeProjectId: null,
        activeTab: 'chatbot',
        isGenerating: false,
        abortController: null,
        theme: localStorage.getItem(LOCAL_STORAGE_KEY.THEME) || 'light',
    };

    const el = {};
    const elIds = [
        'left-sidebar', 'toggle-left-sidebar', 'sidebar-overlay', 'theme-btn',
        'chatbot-tab-btn', 'workspace-tab-btn', 'view-title',
        'chatbot-sidebar-content', 'workspace-sidebar-content',
        'chatbot-view', 'workspace-view', 'chat-history', 'welcome-message',
        'prompt-input', 'send-btn', 'model-switcher', 'chatbot-footer',
        'status-bar', 'status-text', 'status-dot',
        'new-chat-btn', 'chat-list', 'new-project-btn', 'project-list',
        'workspace-outline', 'workspace-script', 'generate-script-btn',
        'workspace-script-container', 'line-count-slider', 'line-count-value'
    ];
    elIds.forEach(id => {
        const camelCaseId = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
        el[camelCaseId] = document.getElementById(id);
    });

    function init() {
        applyTheme();
        addEventListeners();
        checkServerStatus();
    }

    const save = {
        chats: () => localStorage.setItem(LOCAL_STORAGE_KEY.CHATS, JSON.stringify(state.chats)),
        projects: () => localStorage.setItem(LOCAL_STORAGE_KEY.PROJECTS, JSON.stringify(state.projects)),
        theme: () => localStorage.setItem(LOCAL_STORAGE_KEY.THEME, state.theme)
    };

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', state.theme);
        el.themeBtn.innerHTML = state.theme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        save.theme();
    }
    
    function populateModelSwitcher() {
        el.modelSwitcher.innerHTML = '';
        for (const modelId in state.availableModels) {
            const model = state.availableModels[modelId];
            const option = new Option(model.name, modelId);
            el.modelSwitcher.add(option);
        }
    }

    function switchTab(tab) {
        state.activeTab = tab;
        const isChatbot = tab === 'chatbot';
        
        el.chatbotTabBtn.classList.toggle('active', isChatbot);
        el.workspaceTabBtn.classList.toggle('active', !isChatbot);

        el.chatbotView.style.display = isChatbot ? 'flex' : 'none';
        el.chatbotFooter.style.display = isChatbot ? 'block' : 'none';
        el.workspaceView.style.display = !isChatbot ? 'flex' : 'none';
        
        el.chatbotSidebarContent.style.display = isChatbot ? 'flex' : 'none';
        el.workspaceSidebarContent.style.display = !isChatbot ? 'flex' : 'none';

        if (isChatbot) {
            if (state.chats.length === 0) createNewChat();
            selectChat(state.activeChatId || state.chats[0]?.id);
        } else {
            if (state.projects.length === 0) createNewProject(true);
            selectProject(state.activeProjectId || state.projects[0]?.id);
        }
    }

    function renderChatList() {
        const sortedChats = [...state.chats].sort((a, b) => b.id - a.id);
        el.chatList.innerHTML = sortedChats.map(c => `
            <div class="chat-item group relative flex items-center p-2 rounded-lg cursor-pointer ${c.id === state.activeChatId ? 'bg-indigo-100 dark:bg-white/10' : 'hover:bg-black/5 dark:hover:bg-white/5'}" data-chat-id="${c.id}">
                <i class="fa-regular fa-message w-6 text-center text-[var(--text-secondary)]"></i>
                <span class="ml-2 flex-grow truncate text-sm sidebar-text font-medium">${c.name}</span>
            </div>
        `).join('');
    }

    function renderProjectList() {
        const sortedProjects = [...state.projects].sort((a, b) => b.id - a.id);
        el.projectList.innerHTML = sortedProjects.map(p => `
            <div class="project-item group relative flex items-center p-2 rounded-lg cursor-pointer ${p.id === state.activeProjectId ? 'bg-indigo-100 dark:bg-white/10' : 'hover:bg-black/5 dark:hover:bg-white/5'}" data-project-id="${p.id}">
                <i class="fa-regular fa-folder w-6 text-center text-[var(--text-secondary)]"></i>
                <span class="ml-2 flex-grow truncate text-sm sidebar-text font-medium">${p.name}</span>
                <button data-action="delete-project" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-transparent group-hover:text-[var(--text-secondary)] hover:bg-red-500/10 text-red-500"><i class="fa-solid fa-trash-can"></i></button>
            </div>
        `).join('');
    }

    function addMessageToHistory(role, text) {
        el.welcomeMessage.style.display = 'none';
        const who = role === 'user' ? 'You' : 'FugthAI';
        const avatarIcon = role === 'user' ? 'fa-user' : 'fa-brain';
        const messageBg = role === 'user' ? 'bg-[var(--bg-message-user)]' : 'bg-[var(--bg-message-bot)]';
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container flex items-start gap-4';
        
        const contentHTML = text ? marked.parse(text) : '<span class="blinking-cursor">▍</span>';
        
        messageContainer.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-black/5 dark:bg-white/10 flex items-center justify-center text-lg text-[var(--text-secondary)] flex-shrink-0 mt-1"><i class="fa-solid ${avatarIcon}"></i></div>
            <div class="flex-1 p-4 rounded-xl ${messageBg} border border-[var(--border-color)]">
                <strong class="text-sm font-semibold mb-2 block">${who}</strong>
                <div class="prose max-w-none text-content">${contentHTML}</div>
            </div>
        `;
        
        el.chatHistory.appendChild(messageContainer);
        addCodeCopyButtons(messageContainer);
        el.chatbotView.scrollTop = el.chatbotView.scrollHeight;
        return messageContainer;
    }
    
    function addCodeCopyButtons(container) {
        container.querySelectorAll('pre').forEach(pre => {
            if (pre.querySelector('.copy-btn') || !pre.querySelector('code')) return;
            const btn = document.createElement('button');
            btn.className = 'copy-btn';
            btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy';
            btn.onclick = () => {
                navigator.clipboard.writeText(pre.querySelector('code').innerText).then(() => {
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                    setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy'; }, 2000);
                });
            };
            pre.appendChild(btn);
        });
    }

    function selectChat(id) {
        if (!id) return;
        state.activeChatId = id;
        const chat = state.chats.find(c => c.id === id);
        if (chat) {
            el.viewTitle.textContent = chat.name;
            el.chatHistory.innerHTML = '';
            if (chat.history.length === 0) {
                el.welcomeMessage.style.display = 'block';
            } else {
                el.welcomeMessage.style.display = 'none';
                chat.history.forEach(m => addMessageToHistory(m.role, m.text));
            }
        }
        renderChatList();
    }
    
    function selectProject(id) {
        if (!id) {
            el.viewTitle.textContent = "Workspace";
            el.workspaceOutline.value = "";
            el.workspaceScript.textContent = "Select or create a project.";
            hljs.highlightElement(el.workspaceScript);
            return;
        }
        state.activeProjectId = id;
        const project = state.projects.find(p => p.id === id);
        if (project) {
            el.viewTitle.textContent = project.name;
            el.workspaceOutline.value = project.outline;
            el.workspaceScript.textContent = project.script || "No script generated yet.";
            hljs.highlightElement(el.workspaceScript);
        }
        renderProjectList();
    }

    function createNewChat() {
        const newChat = { id: Date.now(), name: 'New Chat', history: [] };
        state.chats.unshift(newChat);
        save.chats();
        selectChat(newChat.id);
    }
    
    function createNewProject(isInitial = false) {
        const projectName = isInitial ? 'My First Project' : prompt('Enter a name for your new project:');
        if (!projectName) return;

        const newProject = { id: Date.now(), name: projectName, outline: '', script: '' };
        state.projects.unshift(newProject);
        save.projects();
        selectProject(newProject.id);
    }

    async function checkServerStatus() {
        updateStatus('connecting', 'Connecting to AI Server...');
        try {
            const response = await fetch(HUGGING_FACE_URL);
            if (!response.ok) throw new Error(`Server offline (${response.status})`);
            
            const data = await response.json();
            state.availableModels = data.available_models;
            populateModelSwitcher();
            
            el.modelSwitcher.value = data.model_loaded;
            
            updateStatus('connected', `AI Server Online`);
            el.promptInput.disabled = false;
            el.sendBtn.disabled = false;
            el.generateScriptBtn.disabled = false;
        } catch (error) {
            updateStatus('failed', `Connection Failed. Retrying...`);
            setTimeout(checkServerStatus, 5000);
        }
    }

    function updateStatus(status, text) {
        const statusMap = {
            connecting: { color: 'bg-yellow-500', pulse: true },
            connected: { color: 'bg-green-500', pulse: false },
            generating: { color: 'bg-blue-500', pulse: true },
            failed: { color: 'bg-red-500', pulse: false }
        };
        const newStatus = statusMap[status] || statusMap.failed;
        el.statusText.textContent = text;
        el.statusDot.className = `w-2 h-2 rounded-full ${newStatus.color}`;
        el.statusDot.classList.toggle('animate-pulse', newStatus.pulse);
    }

    function setGenerating(isGenerating) {
        state.isGenerating = isGenerating;
        const stopIcon = '<i class="fa-solid fa-stop"></i>';
        const sendIcon = '<i class="fa-solid fa-arrow-up"></i>';
        const genIcon = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generate Script';
        
        el.sendBtn.innerHTML = isGenerating ? stopIcon : sendIcon;
        el.generateScriptBtn.innerHTML = isGenerating ? 'Stop Generating' : genIcon;
        
        el.sendBtn.disabled = isGenerating;
        el.generateScriptBtn.disabled = isGenerating;
        el.promptInput.disabled = isGenerating;
        el.modelSwitcher.disabled = isGenerating;
        
        updateStatus(isGenerating ? 'generating' : 'connected', isGenerating ? 'Assistant is thinking...' : 'AI Server Online');
    }

    async function getAiResponse(prompt, targetElement, saveCallback) {
        const selectedModel = el.modelSwitcher.value;
        setGenerating(true);

        state.abortController = new AbortController();
        let fullResponse = "";

        try {
            const res = await fetch(`${HUGGING_FACE_URL}/chat_stream`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, model_id: selectedModel }),
                signal: state.abortController.signal
            });

            if (!res.ok) throw new Error(`Request failed: ${res.status} ${await res.text()}`);
            if (!res.body) throw new Error("Streaming not supported");

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            
            targetElement.textContent = ''; 
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                fullResponse += decoder.decode(value, { stream: true });

                if (targetElement.tagName === 'CODE') {
                    targetElement.textContent = fullResponse;
                } else {
                    targetElement.querySelector('.text-content').innerHTML = marked.parse(fullResponse + '<span class="blinking-cursor">▍</span>');
                }
            }
            
            if (targetElement.tagName === 'CODE') {
                targetElement.textContent = fullResponse;
                hljs.highlightElement(targetElement);
            } else {
                targetElement.querySelector('.text-content').innerHTML = marked.parse(fullResponse);
                addCodeCopyButtons(targetElement);
            }

            if (saveCallback) saveCallback(fullResponse);

        } catch (e) {
            const errorMessage = e.name === 'AbortError' ? 'Request cancelled.' : `An error occurred: ${e.message}`;
            const errorEl = targetElement.tagName === 'CODE' ? targetElement : targetElement.querySelector('.text-content');
            errorEl.innerHTML = `<span class="text-[var(--danger)]">${errorMessage}</span>`;
        } finally {
            setGenerating(false);
            checkServerStatus();
        }
    }

    async function handleSend() {
        const promptText = el.promptInput.value.trim();
        if (!promptText || state.isGenerating) return;

        const activeChat = state.chats.find(c => c.id === state.activeChatId);
        if (!activeChat) return;

        activeChat.history.push({ role: 'user', text: promptText });
        addMessageToHistory('user', promptText);
        
        if (activeChat.name === 'New Chat' && activeChat.history.length === 1) {
            activeChat.name = promptText.substring(0, 40) + (promptText.length > 40 ? '...' : '');
            renderChatList();
            el.viewTitle.textContent = activeChat.name;
        }
        
        const assistantMessageContainer = addMessageToHistory('assistant', '');
        el.promptInput.value = '';
        el.promptInput.style.height = 'auto';

        const promptForApi = `<|system|>\nYou are a helpful AI assistant.</s>\n<|user|>\n${promptText}</s>\n<|assistant|>\n`;
        getAiResponse(promptForApi, assistantMessageContainer, (response) => {
            activeChat.history.push({ role: 'assistant', text: response });
            save.chats();
        });
    }

    async function handleGenerateScript() {
        const project = state.projects.find(p => p.id === state.activeProjectId);
        if (!project || state.isGenerating) return;

        const lineCount = el.lineCountSlider.value;
        const lineInstruction = lineCount > 0 ? `The script should be approximately ${lineCount} lines long. This is a target, not a strict limit, but try to get reasonably close.` : '';

        const prompt = `
<|system|>
You are an expert programmer. Based on the following project outline, generate a complete, high-quality code script.
The script should be well-documented and follow best practices. ${lineInstruction}
Only output the raw code, without any additional explanations or markdown formatting like \`\`\`python.
Project Title: "${project.name}"
Outline & Notes:
${project.outline}
</s>
<|user|>
Generate the complete script now.
</s>
<|assistant|>
`.trim();
        
        getAiResponse(prompt, el.workspaceScript, (response) => {
            project.script = response;
            save.projects();
        });
    }

    function addEventListeners() {
        el.themeBtn.onclick = () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
        };

        el.chatbotTabBtn.onclick = () => switchTab('chatbot');
        el.workspaceTabBtn.onclick = () => switchTab('workspace');
        el.newChatBtn.onclick = createNewChat;
        el.newProjectBtn.onclick = () => createNewProject(false);

        el.sendBtn.onclick = handleSend;
        el.promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }});
        
        el.generateScriptBtn.onclick = handleGenerateScript;
        el.lineCountSlider.addEventListener('input', (e) => {
            el.lineCountValue.textContent = e.target.value;
        });
        
        el.chatList.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (item) selectChat(parseInt(item.dataset.chatId));
        });

        el.projectList.addEventListener('click', (e) => {
            const item = e.target.closest('.project-item');
            if (e.target.closest('[data-action="delete-project"]')) {
                 if (confirm('Are you sure you want to delete this project?')) {
                    const projectId = parseInt(item.dataset.projectId);
                    state.projects = state.projects.filter(p => p.id !== projectId);
                    save.projects();
                    if (state.activeProjectId === projectId) {
                        state.activeProjectId = state.projects[0]?.id || null;
                        selectProject(state.activeProjectId);
                    } else {
                        renderProjectList();
                    }
                 }
            } else if (item) {
                selectProject(parseInt(item.dataset.projectId));
            }
        });
        
        el.workspaceOutline.addEventListener('input', () => {
             const project = state.projects.find(p => p.id === state.activeProjectId);
             if (project) {
                project.outline = el.workspaceOutline.value;
                save.projects();
             }
        });
    }

    init();
});
</script>
</body>
</html>
